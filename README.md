# RESTful API Producer ‚Äì AWS SQS

<div align="center">
  <img src="https://img.shields.io/static/v1?label=python&message=language&color=blue&style=for-the-badge&logo=python"/>
  <img src="https://img.shields.io/static/v1?label=fastapi&message=framework&color=green&style=for-the-badge&logo=fastapi"/>
  <img src="https://img.shields.io/static/v1?label=lambda&message=runtime&color=orange&style=for-the-badge&logo=aws"/>
  <img src="https://img.shields.io/static/v1?label=boto3&message=SDK&color=yellow&style=for-the-badge"/>
  <img src="https://img.shields.io/static/v1?label=docker&message=container&color=blue&style=for-the-badge&logo=docker"/>
  <img src="https://img.shields.io/static/v1?label=openapi&message=docs&color=red&style=for-the-badge"/>
  <img src="http://img.shields.io/static/v1?label=STATUS&message=Development&color=GREEN&style=for-the-badge"/>
</div>

<div align="center">
  <img src="docs/architecture.png" alt="Arquitetura da API" width="600"/>
</div>

> Esta API RESTful tem como objetivo permitir o envio e consumo de mensagens em filas AWS SQS, oferecendo endpoints para produ√ß√£o, consulta de status e reprocessamento de mensagens em DLQ. A arquitetura √© baseada em Lambda com FastAPI + Mangum, garantindo processamento ass√≠ncrono, idempot√™ncia e observabilidade.

---

## üìù Vis√£o Geral / Objetivo

* Desenvolver um **produtor de mensagens** para SQS com endpoints RESTful.
* Permitir **consulta de status** das filas e DLQ.
* Implementar **reprocessamento de mensagens DLQ** com preven√ß√£o de loops e tratamento de mensagens inv√°lidas.
* Garantir **idempot√™ncia**, **logs detalhados**, m√©tricas b√°sicas e containeriza√ß√£o via Docker.
* Fornecer documenta√ß√£o **OpenAPI/Swagger** completa.

---

## üèõ Arquitetura

A solu√ß√£o segue a arquitetura serverless e distribu√≠da:

* **API Gateway** ‚Üí exp√µe endpoints da API.
* **Lambda Producer** ‚Üí envia mensagens para fila SQS FIFO.
* **SQS FIFO Queue** ‚Üí fila principal, com **DLQ** configurada.
* **Lambda Consumer Worker** ‚Üí processa mensagens de forma ass√≠ncrona.
* **DynamoDB** ‚Üí gerencia metadados das mensagens e garante idempot√™ncia.
* **CloudWatch** ‚Üí logs e m√©tricas.

---

## ‚öñ Decis√£o de Consumo: Lambda vs ECS

| Crit√©rio                  | Lambda (Escolhido)   | ECS Fargate (Alternativa) |
| ------------------------- | -------------------- | ------------------------- |
| Complexidade de setup     | Baixa                | M√©dia/Alta                |
| Escalabilidade            | Autom√°tica           | Manual / Configur√°vel     |
| Custos                    | Pay-per-use          | Cont√™iner sempre ativo    |
| Lat√™ncia de processamento | Imediata             | Vari√°vel                  |
| Retentativas / DLQ        | Configur√°vel via SQS | Manual/Programada         |
| Observabilidade           | Integrada CloudWatch | Integrar manualmente      |

> **Justificativa:** Lambda oferece escalabilidade autom√°tica, f√°cil integra√ß√£o com SQS e menor custo operacional para este caso de uso.

---

## üìÇ Estrutura de Pastas / Padr√µes

```
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ ci-cd.yml                # Pipelines de CI/CD
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.py              # L√≥gica de controllers para mensagens
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users.py                 # L√≥gica de controllers para usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.py                  # Autentica√ß√£o e valida√ß√£o de tokens
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.py              # Defini√ß√£o de rotas para mensagens
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users.py                 # Defini√ß√£o de rotas para usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.py              # Schemas Pydantic de mensagens
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ responses.py             # Schemas de respostas gerais
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transactions.py          # Schemas de transa√ß√µes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users.py                 # Schemas de usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ security/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ token.py                 # Gera√ß√£o e valida√ß√£o de tokens JWT
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ messages.py              # L√≥gica de integra√ß√£o com SQS
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ config.py                # Configura√ß√µes de ambiente
‚îÇ       ‚îú‚îÄ‚îÄ logging.py               # Configura√ß√£o de logs
‚îÇ       ‚îú‚îÄ‚îÄ metrics.py               # M√©tricas customizadas
‚îÇ       ‚îú‚îÄ‚îÄ swagger.py               # Configura√ß√£o do Swagger/OpenAPI
‚îÇ       ‚îî‚îÄ‚îÄ validate.py              # Fun√ß√µes utilit√°rias de valida√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ main.py                      # Entrypoint FastAPI + Mangum
‚îú‚îÄ‚îÄ tests/                           # Testes unit√°rios
‚îú‚îÄ‚îÄ .env.sample                      # Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ .gitignore                       # Arquivos e pastas ignoradas no Git
‚îú‚îÄ‚îÄ Dockerfile                       # Dockerfile para containeriza√ß√£o
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt                 # Depend√™ncias do projeto
‚îî‚îÄ‚îÄ requirements_test.txt            # Depend√™ncias para testes

```

---

## üîå Endpoints (OpenAPI)

* **POST /messages/send** ‚Äì Envia mensagem para fila SQS.
* **GET /messages/status** ‚Äì Consulta status da fila principal e DLQ.
* **POST /messages/dlq/reprocess** ‚Äì Reprocessa mensagens da DLQ para a fila principal.
* **POST /users/login** ‚Äì Gera token de autentica√ß√£o.

Acesse a documenta√ß√£o interativa: [Swagger UI Localmente](http://localhost:8000/docs)
ou [Swagger UI AWS](https://fqgn7lclxb.execute-api.us-east-1.amazonaws.com/docs)

---

## üîÑ Fluxo de Processamento de Mensagens

1. Produ√ß√£o via POST `/messages/send`.
2. Mensagem salva em **DynamoDB** para rastreio e idempot√™ncia.
3. Lambda Worker consome mensagens da fila principal.
4. Processamento ass√≠ncrono e logging via CloudWatch.
5. Mensagens inv√°lidas ou que excedem retentativas ‚Üí DLQ.

---

## ‚ö† Tratamento de Erros, Retentativas e DLQ

* Configura√ß√£o de **SQS FIFO + DLQ FIFO**.
* Mensagens inv√°lidas movidas para DLQ.
* Retentativas autom√°ticas configuradas via SQS (maxReceiveCount).
* Preven√ß√£o de loops na reprocessamento da DLQ.

---

## ‚úÖ Idempot√™ncia

Implementada **em dois n√≠veis**:

- **DynamoDB**: cada mensagem possui uma chave √∫nica que garante que mensagens duplicadas n√£o sejam processadas novamente.
- **SQS FIFO + DLQ FIFO**: utiliza o atributo `MessageDeduplicationId` para prevenir duplica√ß√µes na fila, mesmo em casos de reenvio ou falhas tempor√°rias.

Essa combina√ß√£o assegura que o processamento de mensagens seja **idempotente**, evitando que mensagens duplicadas gerem efeitos colaterais indesejados e garantindo a integridade tanto do fluxo de mensagens quanto do reprocessamento da DLQ.

---

## üìä Observabilidade

A API possui um sistema de **logs estruturados** e **m√©tricas customizadas**, permitindo monitoramento detalhado das opera√ß√µes.

### Logs Detalhados

* Todos os eventos importantes s√£o registrados via `logger` do Python.
* Os logs s√£o estruturados em **JSON** com os seguintes campos:

  * `trace_id`: identificador √∫nico da opera√ß√£o, √∫til para rastrear o fluxo.
  * `action`: opera√ß√£o realizada (ex: `send_message`, `get_status`, `reprocess_dlq`, `user_login`).
  * `status`: estado da opera√ß√£o (`started`, `success`, `error`).
  * `details`: informa√ß√µes adicionais, como nome da fila, dura√ß√£o ou erro.
  * `timestamp`: hor√°rio UTC da execu√ß√£o.

**Exemplo de log:**

```json
{
  "trace_id": "51063aff-594b-41c7-9ddd-649817dfefa3",
  "action": "send_message",
  "status": "success",
  "details": {"queue_name": "main_queue", "duration": 0.124},
  "timestamp": "2025-10-05T20:26:22.883320+00:00"
}
```

### M√©tricas Customizadas

As m√©tricas s√£o enviadas para **AWS CloudWatch**, usando o namespace `API-Producer-SQS/Messages`.

Principais m√©tricas dispon√≠veis:

| M√©trica               | Descri√ß√£o                                                   |
| --------------------- | ----------------------------------------------------------- |
| `MessagesSent`        | Contagem de mensagens enviadas com sucesso para a fila SQS  |
| `MessagesReprocessed` | Quantidade de mensagens reprocessadas da DLQ                |
| `ProcessingTime`      | Tempo m√©dio de processamento de cada opera√ß√£o (em segundos) |
| `Errors`              | Contagem de erros ocorridos durante opera√ß√µes               |
| `FailedLogins`        | Tentativas de login inv√°lidas                               |
| `SuccessfulLogins`    | Logins autenticados com sucesso                             |


> Essa abordagem garante visibilidade completa do fluxo de mensagens, incluindo produ√ß√£o, consumo ass√≠ncrono via Lambda e reprocessamento da DLQ, facilitando detec√ß√£o de falhas e an√°lise de desempenho.

---

## üîí Seguran√ßa

* Endpoint `/users/login` gera **token JWT**.
* Token necess√°rio em headers `Authorization` para outros endpoints.

---

## üè° Como Executar Localmente

**Pr√©-requisitos:** Python 3.11, credenciais de acesso √† AWS com os recursos j√° criados.

### Passo a passo

* Clone o reposit√≥rio:

```bash
git clone https://github.com/ViniciusGR797/producer-sqs-api.git
cd producer-sqs-api
```

* Crie e ative um ambiente virtual Python (`venv`):

```bash
python -m venv venv
```

```bash
# Linux / macOS
source venv/bin/activate

# Windows
venv\Scripts\activate
```

* Instale as depend√™ncias do projeto:

```bash
pip install -r requirements.txt
```

* Crie um arquivo `.env` a partir de `.env.sample`:

```bash
APP_USER_EMAIL=user@example.com
APP_USER_PASSWORD=strongpassword123
JWT_SECRET_KEY=<random_secret_key>
JWT_ACCESS_TOKEN_EXPIRES=6
REGION=us-east-1
SQS_NAME=main_queue.fifo
DLQ_NAME=dlq_queue.fifo
```

* Configure as vari√°veis de ambiente definindo suas credenciais AWS e outras vari√°veis:

```bash
export ENV=LOCAL
export AWS_ACCESS_KEY_ID="sua_access_key_id"
export AWS_SECRET_ACCESS_KEY="sua_secret_access_key"
export AWS_DEFAULT_REGION="sua_regiao"
```

> Essas vari√°veis permitem que a aplica√ß√£o acesse os recursos AWS j√° existentes na sua conta.

* Executar a API:
```bash
python "app\main.py"
```

* Acessar a documenta√ß√£o via [Swagger UI](http://localhost:8080/docs)

* Collection do [Insomnia](http://localhost:8080/docs) para consumir os endpoints.

---

## üß™ Testes

Todos os testes est√£o localizados na pasta `tests/` e pressup√µem que voc√™ j√° tenha seguido os passos para **executar localmente** (ambiente virtual ativado, depend√™ncias instaladas e vari√°veis de ambiente configuradas).

Para rodar os testes sigas os passos:

* Instale as depend√™ncias de teste adicionais:

```bash
pip install -r requirements_test.txt
```

* Execute os testes unit√°rios com `pytest`:

```bash
pytest -v
```